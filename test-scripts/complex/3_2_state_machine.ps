PRINT "=== Complex State Machine Simulator ==="
PRINT "Simulating a vending machine with multiple states"
PRINT ""

FLEX state = 0
FLEX balance = 0
FLEX itemPrice = 150
FLEX coinsInserted = 0
FLEX changeAmount = 0
FLEX itemDispensed = 0
FLEX maxCycles = 20

PRINT "Vending Machine Initialized"
PRINT "Item Price: 150 cents"
PRINT ""

CYCLE 20 AS cycle {
    FLEX cycleNum = cycle + 1
    
    PRINT "--- Cycle"
    PRINT cycleNum
    PRINT "---"
    
    IF state == 0 {
        PRINT "State: IDLE"
        PRINT "Waiting for coins..."
        
        FLEX coinValue = 0
        FLEX coinType = cycleNum / 4
        FLEX remainder = coinType * 4
        
        IF remainder == cycleNum {
            FLEX coinValue = 50
        } ELSE {
            FLEX coinValue = 25
        }
        
        PRINT "Inserting coin:"
        PRINT coinValue
        
        FLEX balance = balance + coinValue
        FLEX coinsInserted = coinsInserted + 1
        
        PRINT "Balance:"
        PRINT balance
        
        IF balance > itemPrice OR balance == itemPrice {
            FLEX state = 1
            PRINT "Transitioning to VENDING state"
        }
    }
    
    IF state == 1 {
        PRINT "State: VENDING"
        PRINT "Dispensing item..."
        
        FLEX itemDispensed = itemDispensed + 1
        PRINT "Item dispensed! Total items:"
        PRINT itemDispensed
        
        FLEX changeAmount = balance - itemPrice
        PRINT "Change due:"
        PRINT changeAmount
        
        IF changeAmount > 0 {
            FLEX state = 2
            PRINT "Transitioning to CHANGE state"
        } ELSE {
            FLEX state = 0
            FLEX balance = 0
            PRINT "Transitioning to IDLE state"
        }
    }
    
    IF state == 2 {
        PRINT "State: CHANGE"
        PRINT "Dispensing change..."
        
        FLEX quarters = 0
        FLEX dimes = 0
        FLEX nickels = 0
        FLEX remaining = changeAmount
        
        CYCLE 10 AS quarterCount {
            IF remaining > 24 {
                FLEX quarters = quarters + 1
                FLEX remaining = remaining - 25
            }
        }
        
        CYCLE 10 AS dimeCount {
            IF remaining > 9 {
                FLEX dimes = dimes + 1
                FLEX remaining = remaining - 10
            }
        }
        
        CYCLE 10 AS nickelCount {
            IF remaining > 4 {
                FLEX nickels = nickels + 1
                FLEX remaining = remaining - 5
            }
        }
        
        PRINT "Change breakdown:"
        PRINT "Quarters:"
        PRINT quarters
        PRINT "Dimes:"
        PRINT dimes
        PRINT "Nickels:"
        PRINT nickels
        
        FLEX state = 0
        FLEX balance = 0
        PRINT "Transitioning to IDLE state"
    }
    
    PRINT ""
}

PRINT "=== Simulation Complete ==="
PRINT ""
PRINT "Final Statistics:"
PRINT "Total coins inserted:"
PRINT coinsInserted
PRINT "Total items dispensed:"
PRINT itemDispensed
PRINT "Final state:"
PRINT state
